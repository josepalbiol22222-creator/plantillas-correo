<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lova â€” Template Collection</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;600;700;800&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

  :root {
    --bg: #FAF9F7;
    --card: #FFFFFF;
    --primary: #C94D7C;
    --primary-light: #F2D5E0;
    --primary-soft: #FDF0F4;
    --primary-dark: #A93D65;
    --text: #1A1A1A;
    --text-muted: #8A8A8A;
    --text-light: #B0B0B0;
    --border: #E8E4DE;
    --muted-bg: #F5F3F0;
    --green: #2ABFAB;
    --green-soft: #E6F9F5;
    --radius: 16px;
    --radius-sm: 12px;
    --radius-xs: 8px;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
    --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 0 0 1px rgba(0,0,0,0.02);
    --shadow-lg: 0 8px 30px rgba(0,0,0,0.08);
    --transition: 0.2s ease;
  }

  html { scroll-behavior: smooth; }

  body {
    font-family: 'DM Sans', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }

  /* === LAYOUT === */
  .page {
    max-width: 640px;
    margin: 0 auto;
    padding: 0 1.25rem;
  }

  /* === HEADER === */
  .header {
    text-align: center;
    padding: 3.5rem 1rem 2rem;
  }

  .lova-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 1rem;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 100px;
    font-size: 0.82rem;
    color: var(--primary);
    font-weight: 600;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-sm);
  }

  .lova-badge svg { width: 14px; height: 14px; }

  .header h1 {
    font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
    font-size: clamp(2rem, 6vw, 2.8rem);
    font-weight: 700;
    color: var(--text);
    line-height: 1.15;
    letter-spacing: -0.03em;
    margin-bottom: 0.75rem;
  }

  .header h1 span {
    background: linear-gradient(135deg, var(--primary), #E87EA1);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .header p {
    color: var(--text-muted);
    font-size: 0.95rem;
    max-width: 440px;
    margin: 0 auto;
    line-height: 1.65;
  }

  /* === COUNTER === */
  .counter-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1.5rem;
    font-size: 0.8rem;
    color: var(--text-muted);
    font-weight: 500;
  }

  .counter-dot {
    width: 7px;
    height: 7px;
    background: var(--green);
    border-radius: 50%;
    animation: pulse 2.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.85); }
  }

  /* === FORM CARD === */
  .form-section {
    margin-bottom: 2.5rem;
  }

  .form-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 1.75rem;
    box-shadow: var(--shadow);
    transition: box-shadow var(--transition);
  }

  .form-card:focus-within {
    box-shadow: var(--shadow-lg);
  }

  .form-card label {
    display: block;
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
    letter-spacing: 0.02em;
    text-transform: uppercase;
  }

  .field-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .field-group {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  input, textarea {
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 0.9rem;
    padding: 0.65rem 0.85rem;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-xs);
    background: var(--bg);
    color: var(--text);
    transition: all var(--transition);
    outline: none;
    width: 100%;
  }

  input:focus, textarea:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
    background: var(--card);
  }

  input::placeholder, textarea::placeholder {
    color: var(--text-light);
  }

  textarea {
    resize: vertical;
    min-height: 200px;
    line-height: 1.75;
    font-size: 0.88rem;
  }

  .template-area {
    margin-bottom: 1rem;
  }

  .form-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .form-hint {
    font-size: 0.78rem;
    color: var(--text-light);
  }

  .btn-submit {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    padding: 0.7rem 1.5rem;
    background: linear-gradient(135deg, var(--primary), #D75A86);
    color: #fff;
    border: none;
    border-radius: var(--radius-xs);
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 0.88rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
    flex-shrink: 0;
  }

  .btn-submit:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 14px rgba(201, 77, 124, 0.35);
  }

  .btn-submit:active { transform: translateY(0); }
  .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
  .btn-submit svg { width: 15px; height: 15px; }

  /* === TEMPLATES LIST === */
  .templates-section {
    padding-bottom: 4rem;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .section-title {
    font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text);
  }

  .section-count {
    font-size: 0.78rem;
    color: var(--text-light);
    font-weight: 500;
  }

  .search-bar {
    position: relative;
    margin-bottom: 1rem;
  }

  .search-bar svg {
    position: absolute;
    left: 0.85rem;
    top: 50%;
    transform: translateY(-50%);
    width: 15px;
    height: 15px;
    color: var(--text-light);
    pointer-events: none;
  }

  .search-bar input {
    width: 100%;
    padding-left: 2.4rem;
    background: var(--card);
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
  }

  /* === TEMPLATE CARDS === */
  .templates-list {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }

  .tpl-card {
    background: var(--card);
    border-radius: var(--radius-sm);
    padding: 1.15rem 1.25rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all var(--transition);
    position: relative;
    animation: cardIn 0.3s ease backwards;
  }

  .tpl-card:hover {
    box-shadow: var(--shadow);
    border-color: var(--primary-light);
    transform: translateY(-1px);
  }

  @keyframes cardIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .tpl-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    margin-bottom: 0.35rem;
  }

  .tpl-name {
    font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
    font-size: 0.92rem;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .tpl-meta {
    font-size: 0.75rem;
    color: var(--text-light);
    flex-shrink: 0;
  }

  .tpl-preview {
    font-size: 0.82rem;
    color: var(--text-muted);
    line-height: 1.55;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* === EXPANDED === */
  .tpl-expanded {
    display: none;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
    animation: fadeIn 0.2s ease;
  }

  .tpl-expanded.show { display: block; }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .tpl-body {
    background: var(--muted-bg);
    border-radius: var(--radius-xs);
    padding: 1rem 1.15rem;
    font-size: 0.85rem;
    line-height: 1.8;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: var(--text);
    margin-bottom: 0.85rem;
    max-height: 280px;
    overflow-y: auto;
  }

  .tpl-actions {
    display: flex;
    gap: 0.4rem;
    justify-content: flex-end;
  }

  .btn-sm {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.4rem 0.85rem;
    border-radius: var(--radius-xs);
    border: 1px solid var(--border);
    background: var(--card);
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 0.76rem;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition);
    color: var(--text-muted);
  }

  .btn-sm:hover { border-color: var(--primary-light); color: var(--primary); }
  .btn-sm.danger:hover { border-color: #F5C6C6; color: #D9534F; background: #FFF8F8; }
  .btn-sm svg { width: 13px; height: 13px; }

  /* === EMPTY STATE === */
  .empty {
    text-align: center;
    padding: 3rem 1.5rem;
  }

  .empty-icon {
    width: 52px;
    height: 52px;
    margin: 0 auto 0.85rem;
    background: var(--primary-soft);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .empty-icon svg { width: 22px; height: 22px; color: var(--primary); }

  .empty h3 {
    font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
    font-weight: 600;
    font-size: 1rem;
    color: var(--text);
    margin-bottom: 0.3rem;
  }

  .empty p { font-size: 0.82rem; color: var(--text-muted); }

  /* === TOAST === */
  .toast-wrap {
    position: fixed;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.4rem;
  }

  .toast {
    padding: 0.7rem 1.15rem;
    background: var(--text);
    color: var(--bg);
    border-radius: var(--radius-xs);
    font-size: 0.82rem;
    font-weight: 500;
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    animation: toastUp 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    white-space: nowrap;
  }

  .toast.out { animation: toastOut 0.25s ease forwards; }
  .toast svg { width: 14px; height: 14px; color: var(--green); flex-shrink: 0; }

  @keyframes toastUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes toastOut {
    to { opacity: 0; transform: translateY(6px); }
  }

  /* === FOOTER === */
  .footer {
    text-align: center;
    padding: 2rem 0 2.5rem;
    font-size: 0.75rem;
    color: var(--text-light);
    border-top: 1px solid var(--border);
    margin-top: 1rem;
  }

  .footer a { color: var(--primary); text-decoration: none; font-weight: 600; }

  /* === RESPONSIVE === */
  @media (max-width: 500px) {
    .header { padding: 2.5rem 0.5rem 1.5rem; }
    .header h1 { font-size: 1.85rem; }
    .form-card { padding: 1.25rem; }
    .field-row { grid-template-columns: 1fr; }
    .form-footer { flex-direction: column; align-items: stretch; }
    .btn-submit { justify-content: center; }
    .form-hint { text-align: center; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<div class="page">
  <header class="header">
    <div class="lova-badge">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
      Template Collection
    </div>
    <h1>Inviaci i tuoi <span>template</span></h1>
    <p>Incolla qui i template email che usi nelle tue campagne outbound. Sceglieremo i migliori per Lova.</p>
    <div class="counter-bar">
      <span class="counter-dot"></span>
      <span id="totalCount">0 template ricevuti</span>
    </div>
  </header>

  <!-- FORM -->
  <section class="form-section">
    <div class="form-card">
      <form id="tplForm" autocomplete="off">
        <div class="field-row">
          <div class="field-group">
            <label for="author">Il tuo nome</label>
            <input type="text" id="author" placeholder="Mario Rossi" required>
          </div>
          <div class="field-group">
            <label for="tplName">Nome del template</label>
            <input type="text" id="tplName" placeholder="es. Follow-up post demo" required>
          </div>
        </div>
        <div class="template-area">
          <label for="tplBody">Template email</label>
          <textarea id="tplBody" placeholder="Incolla qui il tuo template completo...&#10;&#10;Oggetto: [Il tuo oggetto]&#10;&#10;Ciao {nome},&#10;&#10;Ho visto che la vostra azienda...&#10;&#10;Saresti disponibile per una breve call di 15 minuti?&#10;&#10;Grazie,&#10;{firma}" required></textarea>
        </div>
        <div class="form-footer">
          <span class="form-hint">Il template verr&agrave; salvato e valutato dal team</span>
          <button type="submit" class="btn-submit">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            Invia
          </button>
        </div>
      </form>
    </div>
  </section>

  <!-- TEMPLATES -->
  <section class="templates-section">
    <div class="section-header">
      <span class="section-title">Template ricevuti</span>
      <span class="section-count" id="filteredCount"></span>
    </div>
    <div class="search-bar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" id="searchInput" placeholder="Cerca template...">
    </div>
    <div id="tplList" class="templates-list"></div>
  </section>

  <footer class="footer">
    Powered by <a href="https://lovahelpcenter.com" target="_blank">Lova</a>
  </footer>
</div>

<!-- TOAST -->
<div class="toast-wrap" id="toastWrap"></div>

<script>
(function() {
  const SUPABASE_URL = 'https://niazzydglinpzfnadesf.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pYXp6eWRnbGlucHpmbmFkZXNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NDk2OTQsImV4cCI6MjA4NDMyNTY5NH0.9H4XViOrrlJsn3YrhaBFQw1NRO5PYE_aNkjA9PDsqKM';
  const API = `${SUPABASE_URL}/rest/v1/email_templates`;
  const headers = {
    'apikey': SUPABASE_KEY,
    'Authorization': `Bearer ${SUPABASE_KEY}`,
    'Content-Type': 'application/json',
    'Prefer': 'return=representation'
  };

  let templates = [];
  let searchQuery = '';
  let expandedId = null;

  const form = document.getElementById('tplForm');
  const listEl = document.getElementById('tplList');
  const searchInput = document.getElementById('searchInput');
  const totalCount = document.getElementById('totalCount');
  const filteredCount = document.getElementById('filteredCount');

  async function fetchTemplates() {
    try {
      const res = await fetch(`${API}?order=created_at.desc`, { headers });
      if (!res.ok) throw new Error();
      templates = (await res.json()).map(t => ({
        ...t, createdAt: t.created_at, tags: t.tags || []
      }));
      updateCounter();
      render();
    } catch { toast('Errore nel caricamento'); }
  }

  async function insertTemplate(data) {
    const res = await fetch(API, { method: 'POST', headers, body: JSON.stringify(data) });
    if (!res.ok) throw new Error();
    const [row] = await res.json();
    return { ...row, createdAt: row.created_at, tags: row.tags || [] };
  }

  async function deleteTemplate(id) {
    const res = await fetch(`${API}?id=eq.${id}`, { method: 'DELETE', headers });
    if (!res.ok) throw new Error();
  }

  function updateCounter() {
    const n = templates.length;
    totalCount.textContent = n === 1 ? '1 template ricevuto' : `${n} template ricevuti`;
  }

  function toast(msg) {
    const el = document.createElement('div');
    el.className = 'toast';
    el.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>${esc(msg)}`;
    document.getElementById('toastWrap').appendChild(el);
    setTimeout(() => { el.classList.add('out'); setTimeout(() => el.remove(), 250); }, 2500);
  }

  function getFiltered() {
    if (!searchQuery) return templates;
    const q = searchQuery.toLowerCase();
    return templates.filter(t =>
      t.name.toLowerCase().includes(q) ||
      t.body.toLowerCase().includes(q) ||
      t.author.toLowerCase().includes(q)
    );
  }

  function truncate(s, n) { return s.length <= n ? s : s.substring(0, n).trimEnd() + '...'; }

  function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function escA(s) { return s.replace(/[&"'<>]/g, c => ({'&':'&amp;','"':'&quot;',"'":'&#39;','<':'&lt;','>':'&gt;'}[c])); }

  function fmtDate(iso) {
    const d = new Date(iso);
    const m = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
    return `${d.getDate()} ${m[d.getMonth()]} ${d.getFullYear()}`;
  }

  function render() {
    const filtered = getFiltered();
    filteredCount.textContent = searchQuery ? `${filtered.length} risultati` : '';

    if (filtered.length === 0) {
      listEl.innerHTML = `
        <div class="empty">
          <div class="empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div>
          <h3>${templates.length === 0 ? 'Nessun template ancora' : 'Nessun risultato'}</h3>
          <p>${templates.length === 0 ? 'Invia il primo template usando il modulo sopra.' : 'Prova con altri termini di ricerca.'}</p>
        </div>`;
      return;
    }

    listEl.innerHTML = filtered.map((t, i) => {
      const open = expandedId === t.id;
      return `
        <div class="tpl-card" style="animation-delay:${i * 0.03}s" onclick="window.__t('${escA(t.id)}')">
          <div class="tpl-top">
            <span class="tpl-name">${esc(t.name)}</span>
            <span class="tpl-meta">${esc(t.author)} &middot; ${fmtDate(t.createdAt)}</span>
          </div>
          <div class="tpl-preview">${esc(truncate(t.body, 120))}</div>
          <div class="tpl-expanded ${open ? 'show' : ''}">
            <div class="tpl-body">${esc(t.body)}</div>
            <div class="tpl-actions">
              <button class="btn-sm" onclick="event.stopPropagation(); window.__c('${escA(t.id)}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                Copia
              </button>
              <button class="btn-sm danger" onclick="event.stopPropagation(); window.__d('${escA(t.id)}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
                Elimina
              </button>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  // SUBMIT
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = form.querySelector('.btn-submit');
    btn.disabled = true;
    const orig = btn.innerHTML;
    btn.textContent = 'Invio...';
    try {
      const data = {
        author: document.getElementById('author').value.trim(),
        name: document.getElementById('tplName').value.trim(),
        category: 'Otro',
        subject: '-',
        body: document.getElementById('tplBody').value.trim(),
        tags: []
      };
      const row = await insertTemplate(data);
      templates.unshift(row);
      updateCounter();
      form.reset();
      expandedId = null;
      render();
      toast('Template inviato!');
    } catch { toast('Errore nell\'invio'); }
    finally { btn.disabled = false; btn.innerHTML = orig; }
  });

  // SEARCH
  searchInput.addEventListener('input', function() {
    searchQuery = this.value.trim();
    expandedId = null;
    render();
  });

  // TOGGLE
  window.__t = function(id) { expandedId = expandedId === id ? null : id; render(); };

  // COPY
  window.__c = function(id) {
    const t = templates.find(x => x.id === id);
    if (!t) return;
    navigator.clipboard.writeText(t.body).then(() => toast('Copiato!')).catch(() => {
      const ta = document.createElement('textarea'); ta.value = t.body;
      document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
      toast('Copiato!');
    });
  };

  // DELETE
  window.__d = async function(id) {
    if (!confirm('Eliminare questo template?')) return;
    try {
      await deleteTemplate(id);
      templates = templates.filter(x => x.id !== id);
      updateCounter();
      if (expandedId === id) expandedId = null;
      render();
      toast('Template eliminato');
    } catch { toast('Errore'); }
  };

  fetchTemplates();
})();
</script>
</body>
</html>